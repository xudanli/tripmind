# 生成旅程性能分析

## 当前流程（串行执行）

1. **意图检测** (`detectInspirationIntent`)
   - API调用：~500 tokens
   - 预计耗时：2-5秒

2. **构建参考目录** (`buildReferenceCatalog`)
   - 本地操作，从数据库读取
   - 预计耗时：<100ms

3. **生成完整旅程** (`generateInspirationJourney`)
   - 系统提示词：~600行（约3000-4000 tokens）
   - max_tokens: 8192（AI生成的最大token数）
   - 预计耗时：**30-60秒**（主要瓶颈）

## 性能瓶颈分析

### 1. 系统提示词过长
- 当前提示词约600行，包含大量重复说明和详细JSON示例
- 导致：
  - 输入token数高（~3000-4000 tokens）
  - AI处理时间长
  - API调用成本增加

### 2. max_tokens 过高
- 设置为8192（API最大值）
- 即使生成3-5天行程，实际只需要3000-5000 tokens
- 导致：
  - AI生成时间过长
  - 浪费API配额

### 3. 串行执行
- 所有步骤必须等待前一步完成
- 无法并行优化

### 4. 没有缓存机制
- 相同输入每次都重新生成
- 意图检测结果可以缓存

## 优化建议

### 优化1：简化系统提示词
- 移除重复的JSON结构示例（在响应格式中已说明）
- 精简说明文字，保留核心要求
- **预计提速：20-30%**

### 优化2：动态调整 max_tokens
- 根据天数计算：`max_tokens = days * 800 + 2000`（基础开销）
- 例如：3天 = 4400 tokens，6天 = 6800 tokens
- **预计提速：15-25%**

### 优化3：并行执行（可选）
- 意图检测和参考目录构建可以并行
- **预计提速：2-5秒**

### 优化4：添加进度反馈
- 显示当前步骤（"正在分析意图..."、"正在生成行程..."）
- 提升用户体验

### 优化5：缓存机制（可选）
- 缓存意图检测结果（相同输入）
- **预计提速：2-5秒**（对于重复请求）

## 预期优化效果

- **当前平均耗时**：40-70秒
- **优化后平均耗时**：25-45秒
- **提速比例**：约35-40%

