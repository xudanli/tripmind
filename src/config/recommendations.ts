/**
 * 推荐系统配置
 */

import type { ThemeCategory } from '@/types/location'

// 临时使用内联数据（未来可迁移到独立文件）
// TODO: 当数据迁移完成后，从 constants/recommendations-data.ts 导入
const RECOMMENDATIONS: Record<string, Record<string, string[]>> = {
  'CN': {
    '星空观测': ['云南香格里拉', '内蒙古额济纳', '新疆塔克拉玛干', '西藏阿里', '青海茶卡盐湖', '甘肃敦煌雅丹', '四川稻城亚丁', '河北坝上草原'],
    '温泉': ['云南腾冲', '四川海螺沟', '西藏羊八井', '黑龙江大庆', '吉林长白山', '广东从化', '南京汤山', '重庆北温泉'],
    '摄影': ['新疆喀纳斯', '四川色达', '云南元阳梯田', '内蒙古呼伦贝尔', '安徽黄山', '广西桂林', '贵州黄果树', '江西婺源'],
    '艺术': ['北京798', '上海莫干山路', '杭州西湖', '成都宽窄巷子', '广州红专厂', '西安纺织城', '厦门鼓浪屿', '青岛啤酒街'],
    '自然': ['吉林长白山', '四川九寨沟', '云南泸沽湖', '新疆天山', '西藏纳木错', '青海青海湖', '甘肃张掖', '海南三亚'],
    '历史文化': ['北京故宫', '西安兵马俑', '南京中山陵', '洛阳龙门石窟', '敦煌莫高窟', '平遥古城', '拉萨布达拉宫', '承德避暑山庄'],
    '美食': ['成都宽窄巷子', '广州上下九', '西安回民街', '武汉户部巷', '长沙坡子街', '南京夫子庙', '厦门中山路', '哈尔滨中央大街'],
    '徒步': ['西藏珠峰大本营', '四川四姑娘山', '云南虎跳峡', '新疆喀纳斯', '甘肃祁连山', '陕西华山', '安徽黄山', '江西武功山']
  },
  'US': {
    '星空观测': ['亚利桑那死亡谷', '德克萨斯大本德', '犹他州峡谷地', '加利福尼亚约书亚树', '夏威夷莫纳克亚', '科罗拉多落基山', '蒙大拿冰川国家公园', '阿拉斯加德纳里'],
    '温泉': ['怀俄明黄石', '科罗拉多温泉', '加利福尼亚大苏尔', '新墨西哥杰迈兹', '俄勒冈温泉', '阿肯色温泉城', '蒙大拿博兹曼', '阿拉斯加切纳'],
    '摄影': ['阿拉斯加', '犹他州锡安', '加利福尼亚一号公路', '亚利桑那大峡谷', '纽约中央公园', '科罗拉多阿斯彭', '夏威夷火山', '新英格兰秋叶'],
    '艺术': ['纽约格林威治村', '洛杉矶威尼斯海滩', '新奥尔良法国区', '旧金山唐人街', '芝加哥艺术学院', '波士顿昆西市场', '西雅图派克市场', '纳什维尔音乐街'],
    '自然': ['加利福尼亚优胜美地', '科罗拉多落基山', '缅因州阿卡迪亚', '华盛顿奥林匹克', '阿拉斯加峡湾', '夏威夷火山', '佛罗里达大沼泽', '怀俄明大提顿'],
    '城市探索': ['纽约曼哈顿', '洛杉矶好莱坞', '芝加哥密歇根大道', '旧金山金门大桥', '拉斯维加斯大道', '波士顿自由之路', '西雅图太空针', '新奥尔良法国区'],
    '冒险运动': ['科罗拉多滑雪', '加利福尼亚冲浪', '犹他州攀岩', '阿拉斯加狗拉雪橇', '夏威夷潜水', '蒙大拿漂流', '怀俄明登山', '佛罗里达风筝冲浪']
  },
  'JP': {
    '星空观测': ['长野阿智村', '北海道上川郡', '宫崎高千穗', '岐阜飞驒', '冲绳石垣岛', '鹿儿岛屋久岛', '山形藏王', '兵库县淡路岛'],
    '温泉': ['箱根温泉', '草津温泉', '别府温泉', '登别温泉', '有马温泉', '下吕温泉', '道后温泉', '黑川温泉'],
    '摄影': ['北海道路易湖', '京都岚山', '奈良公园', '富士五湖', '东京晴空塔', '大阪城公园', '广岛宫岛', '岐阜白川乡'],
    '艺术': ['东京六本木', '京都花见小路', '大阪道顿堀', '镰仓', '金泽21世纪美术馆', '直岛地中美术馆', '东京国立博物馆', '京都国立博物馆'],
    '自然': ['富士山', '北海道人岛', '京都岚山', '奈良吉野山', '屋久岛绳文杉', '知床半岛', '阿寒湖', '奥入濑溪流'],
    '传统文化': ['京都祇园', '金泽茶屋街', '奈良东大寺', '伊势神宫', '日光东照宫', '姬路城', '松本城', '东京浅草寺'],
    '美食之旅': ['大阪道顿堀', '东京筑地市场', '北海道札幌', '福冈博多', '京都锦市场', '金泽近江町市场', '广岛牡蛎屋', '神户牛肉']
  },
  'KR': {
    '星空观测': ['济州汉拿山', '江原道平昌', '全罗南道莞岛', '庆尚北道郁陵岛', '全罗北道内藏山', '京畿道南汉山', '仁江华岛', '釜山太宗台'],
    '温泉': ['江原道雪岳山', '济州城山日出峰', '釜山温泉', '首尔北汉山', '忠清北道水安堡', '庆尚北道蔚珍', '全罗南道求礼', '京畿道利川'],
    '摄影': ['济州岛', '首尔北村韩屋村', '釜山甘川洞', '全州韩屋村', '庆州佛国寺', '江原道南怡岛', '首尔景福宫', '仁川月尾岛'],
    '艺术': ['首尔弘大', '釜山海云台', '济州岛GD咖啡馆', '仁川中华街', '首尔三清洞', '大邱艺术工厂', '光州双年展', '仁川松岛国际城'],
    '自然': ['济州岛', '江原道南怡岛', '郁陵岛', '全罗南道珍岛', '智异山', '雪岳山', '汉拿山', '内藏山'],
    '韩流文化': ['首尔明洞', '江南区狎鸥亭', 'SM娱乐公司', 'YG娱乐公司', 'JYP娱乐公司', '首尔K-Star路', '济州神话世界', '釜山电影殿堂']
  },
  'SG': {
    '星空观测': ['圣淘沙', '乌敏岛', '新加坡植物园', '滨海花园', '东海岸公园', '裕廊湖花园', '拉布拉多自然保护区', '麦里芝水库'],
    '温泉': ['圣淘沙SPA', '乌节路按摩', '滨海湾金沙', '新加坡河畔', '圣淘沙海底温泉', '裕廊东温泉', '金沙无边泳池', '莱佛士酒店水疗'],
    '摄影': ['滨海湾', '小印度', '牛车水', '克拉码头', '哈芝巷', '阿拉伯街', '如切路', '星耀樟宜'],
    '艺术': ['国家美术馆', '新加坡艺术博物馆', '克拉码头', '滨海艺术中心', '吉尔曼兵营', '丹戎巴葛保留区', '亚洲文明博物馆', '红点设计博物馆'],
    '自然': ['新加坡植物园', '滨海湾花园', '乌敏岛', '东海岸公园', '麦里芝自然保护区', '双溪布洛湿地', '裕廊飞禽公园', '河川生态园'],
    '家庭亲子': ['圣淘沙名胜世界', '环球影城', 'S.E.A.海洋馆', '河川生态园', '动物园', '裕廊飞禽公园', '科学中心', '滨海湾花园儿童乐园'],
    '购物美食': ['乌节路', '滨海湾金沙', 'VivoCity', '牛车水美食街', '老巴刹', '麦士威熟食中心', '小印度竹脚中心', '克拉码头']
  },
  'TH': {
    '海滩度假': ['普吉岛', '苏梅岛', '甲米', '皮皮岛', '华欣', '芭堤雅', '象岛', '丽贝岛'],
    '文化探索': ['曼谷大皇宫', '清迈古城', '素可泰历史公园', '大城府', '清莱白庙', '拜县', '南邦', '乌隆他尼'],
    '美食': ['曼谷唐人街', '清迈周末夜市', '普吉镇', '华欣夜市', '芭堤雅步行街', '甲米奥南海滩', '苏梅岛查汶海滩', '拜县步行街']
  },
  'MY': {
    '城市风情': ['吉隆坡双子塔', '槟城乔治市', '马六甲古城', '兰卡威', '沙巴亚庇', '古晋', '新山', '怡保'],
    '自然探险': ['京那巴鲁山', '热浪岛', '停泊岛', '邦咯岛', '金马伦高原', '云顶高原', '姆鲁山国家公园', '西巴丹岛']
  },
  'ID': {
    '海岛度假': ['巴厘岛', '龙目岛', '吉利群岛', '科莫多岛', 'Flores岛', '爪哇岛', '苏门答腊', '加里曼丹'],
    '火山探险': ['布罗莫火山', '宜珍火山', '林贾尼火山', '默拉皮火山', '喀拉喀托火山', '阿贡火山', '巴图尔火山', '塞梅鲁火山']
  },
  'AU': {
    '自然奇观': ['大堡礁', '乌鲁鲁', '大洋路', '蓝山', '塔斯马尼亚', '卡卡杜', '弗雷泽岛', '袋鼠岛'],
    '城市生活': ['悉尼歌剧院', '墨尔本联邦广场', '布里斯班南岸', '珀斯Kings Park', '阿德莱德Glenelg', '堪培拉国会大厦', '黄金海岸', '凯恩斯']
  },
  'GB': {
    '历史文化': ['伦敦塔桥', '爱丁堡城堡', '巨石阵', '巴斯罗马浴场', '约克大教堂', '剑桥大学', '牛津大学', '温莎城堡'],
    '自然风光': ['湖区国家公园', '苏格兰高地', '科茨沃尔德', '侏罗纪海岸', '斯诺登尼亚', '峰区国家公园', '坎布里亚湖', '北爱尔兰巨人之路'],
    '城市探索': ['伦敦眼', '大本钟', '白金汉宫', '大英博物馆', '海德公园', '诺丁山', '格林威治', '泰晤士河'],
    '艺术文学': ['莎士比亚故居', '哈利波特影城', '福尔摩斯博物馆', '简·奥斯汀中心', '勃朗特故居', '国王十字车站', '贝克街221B', '爱丁堡文学酒吧']
  },
  'FR': {
    '浪漫之旅': ['巴黎埃菲尔铁塔', '普罗旺斯', '蔚蓝海岸', '卢瓦尔河谷', '圣米歇尔山', '科尔马', '安纳西', '吉维尼'],
    '艺术文化': ['卢浮宫', '奥赛博物馆', '蓬皮杜中心', '凡尔赛宫', '橘园美术馆', '罗丹博物馆', '马蒂斯博物馆', '毕加索博物馆'],
    '美食美酒': ['勃艮第酒庄', '波尔多酒庄', '普罗旺斯薰衣草', '诺曼底苹果酒', '阿尔萨斯白葡萄酒', '香槟区', '美食小镇里昂', '布列塔尼海鲜'],
    '自然风光': ['阿尔卑斯山', '普罗旺斯薰衣草田', '多尔多涅河谷', '科西嘉岛', '比利牛斯山', '布列塔尼海岸', '诺曼底海岸', '蔚蓝海岸']
  },
  'IT': {
    '文艺复兴': ['佛罗伦萨', '罗马斗兽场', '威尼斯水城', '米兰大教堂', '比萨斜塔', '锡耶纳', '维罗纳', '博洛尼亚'],
    '美食美酒': ['托斯卡纳葡萄酒', '意大利面制作', '披萨发源地', '橄榄油庄园', '奶酪工厂', '摩德纳香醋', '帕尔马火腿', '西西里甜品'],
    '自然风光': ['阿马尔菲海岸', '西西里岛', '托斯卡纳', '多洛米蒂山', '五渔村', '加尔达湖', '撒丁岛', '卡普里岛'],
    '历史文化': ['庞贝古城', '庞贝遗址', '古罗马广场', '圣彼得大教堂', '西斯廷教堂', '乌菲兹美术馆', '学院美术馆', '斗兽场']
  },
  'DE': {
    '城堡之路': ['新天鹅堡', '海德堡城堡', '霍亨索伦城堡', '维尔茨堡官邸', '林德霍夫宫', '无忧宫', '科隆大教堂', '柏林勃兰登堡门'],
    '历史文化': ['柏林墙', '慕尼黑啤酒节', '德国国会大厦', '柏林大教堂', '纽伦堡', '德累斯顿圣母教堂', '汉堡港', '海德堡老城'],
    '自然风光': ['黑森林', '国王湖', '楚格峰', '萨克森瑞士国家公园', '巴伐利亚阿尔卑斯山', '博登湖', '莱茵河谷', '北海海岸'],
    '工业文化': ['大众汽车城', '宝马世界', '梅赛德斯奔驰博物馆', '鲁尔区工业遗产', '德意志博物馆', '包豪斯档案馆', '科隆巧克力博物馆', '德累斯顿瓷器']
  },
  'ES': {
    '历史建筑': ['巴塞罗那圣家堂', '阿尔罕布拉宫', '马德里皇宫', '塞维利亚大教堂', '高迪建筑', '托莱多古城', '格拉纳达', '科尔多瓦清真寺'],
    '海滩度假': ['马略卡岛', '伊比沙岛', '太阳海岸', '布拉瓦海岸', '坎塔布里亚海岸', '加那利群岛', '巴利阿里群岛', '特内里费岛'],
    '美食文化': ['tapas美食', '西班牙海鲜饭', '伊比利亚火腿', '雪利酒庄', '里奥哈葡萄酒', '巴塞罗那市场', '马德里圣米格尔市场', '安达卢西亚美食'],
    '艺术博物馆': ['普拉多博物馆', '古根海姆博物馆', '索菲亚王后艺术中心', '达利博物馆', '毕加索博物馆', '瓦伦西亚艺术科学城', '马德里艺术三角', '格拉纳达大学']
  }
}

// 主题关键词映射
const THEME_KEYWORDS: Record<string, ThemeCategory> = {
  // 中文关键词
  '星空': '星空观测', '星星': '星空观测', '观星': '星空观测', '夜空': '星空观测',
  '温泉': '温泉', '泡汤': '温泉', '放松': '温泉', '水疗': '温泉',
  '摄影': '摄影', '拍照': '摄影', '摄像': '摄影', '照片': '摄影',
  '艺术': '艺术', '创作': '艺术', '美术': '艺术', '画廊': '艺术',
  '美食': '美食', '吃': '美食', '料理': '美食', '餐厅': '美食',
  '城市': '城市探索', '都市': '城市探索', '市区': '城市探索',
  '冒险': '冒险运动', '极限': '冒险运动', '运动': '冒险运动',
  '历史': '历史文化', '文化': '历史文化', '古迹': '历史文化',
  '徒步': '徒步', '登山': '徒步', '爬山': '徒步', '远足': '徒步',
  
  // 英文关键词
  'star': '星空观测', 'astronomy': '星空观测', 'night': '星空观测',
  'hot': '温泉', 'spring': '温泉', 'spa': '温泉', 'relax': '温泉',
  'photo': '摄影', 'camera': '摄影', 'shoot': '摄影',
  'art': '艺术', 'creative': '艺术', 'gallery': '艺术',
  'food': '美食', 'eat': '美食', 'restaurant': '美食', 'cuisine': '美食',
  'city': '城市探索', 'urban': '城市探索', 'downtown': '城市探索',
  'adventure': '冒险运动', 'extreme': '冒险运动', 'sport': '冒险运动',
  'history': '历史文化', 'culture': '历史文化', 'heritage': '历史文化',
  'hiking': '徒步', 'climb': '徒步', 'trek': '徒步'
}

// 国家特定的主题映射
const COUNTRY_SPECIFIC_THEMES: Record<string, Record<string, ThemeCategory>> = {
  'CN': { '美食': '美食' },
  'JP': { '美食': '美食之旅' },
  'KR': { '美食': '美食之旅' }
}

// 根据国家推荐国内地点
export function getDomesticRecommendations(
  countryCode: string,
  theme: string
): string[] {
  try {
    // 1. 主题分类检测
    const detectedCategory = detectThemeCategory(theme, countryCode)
    
    // 2. 获取推荐
    const recommendations = RECOMMENDATIONS[countryCode]?.[detectedCategory]
    
    // 3. 回退逻辑
    if (!recommendations || recommendations.length === 0) {
      return getFallbackRecommendations(countryCode, detectedCategory)
    }
    
    // 4. 随机排序
    return shuffleArray([...recommendations]).slice(0, 8)
  } catch (error) {
    console.error('获取推荐失败:', error)
    return []
  }
}

// 安全的获取函数
export function getDomesticRecommendationsSafe(
  countryCode: string,
  theme: string
): string[] {
  try {
    return getDomesticRecommendations(countryCode, theme)
  } catch (error) {
    console.error('获取推荐失败:', error)
    return []
  }
}

// 主题检测函数
function detectThemeCategory(theme: string, countryCode: string): ThemeCategory {
  const themeLower = theme.toLowerCase()
  
  // 优先检查国家特定映射
  const countrySpecific = COUNTRY_SPECIFIC_THEMES[countryCode]
  if (countrySpecific) {
    for (const [keyword, category] of Object.entries(countrySpecific)) {
      if (themeLower.includes(keyword.toLowerCase())) {
        return category
      }
    }
  }
  
  // 通用关键词匹配
  for (const [keyword, category] of Object.entries(THEME_KEYWORDS)) {
    if (themeLower.includes(keyword.toLowerCase())) {
      return category
    }
  }
  
  // 默认分类
  return getDefaultCategoryForCountry(countryCode)
}

// 辅助函数
function getFallbackRecommendations(countryCode: string, category: ThemeCategory): string[] {
  const countryRecs = RECOMMENDATIONS[countryCode]
  if (!countryRecs) return []
  
  // 尝试找到该国家的任何推荐
  const firstCategory = Object.keys(countryRecs)[0] as ThemeCategory
  return countryRecs[firstCategory] || []
}

function getDefaultCategoryForCountry(countryCode: string): ThemeCategory {
  const defaults: Record<string, ThemeCategory> = {
    'CN': '自然',
    'US': '自然',
    'JP': '自然',
    'KR': '自然',
    'SG': '城市探索',
    'TH': '海滩度假',
    'MY': '城市风情',
    'ID': '海岛度假',
    'AU': '自然奇观',
    'GB': '历史文化',
    'FR': '浪漫之旅',
    'IT': '文艺复兴',
    'DE': '城堡之路',
    'ES': '历史建筑'
  }
  return defaults[countryCode] || '自然'
}

function shuffleArray<T>(array: T[]): T[] {
  const shuffled = [...array]
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1))
    const temp = shuffled[i]!
    shuffled[i] = shuffled[j] as T
    shuffled[j] = temp
  }
  return shuffled
}
